---
title: "High Resolution, by Dataset, HWI"
author: "Sophie Castel"
date: "2/11/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# test interpolation at very high resolution

#INITIALIZATION
```{r}
gap_vec <- seq(1,30, by = 2)
prop_vec <- seq(0.10,0.30, length.out=20)
K = 100
```

#SIMULATE DATA
```{r}
OriginalData <- load_obj("/home/sophie/sophTools/files/new_2/testOriginalData.rda")
```

#GAPIFY             
```{r}
set.seed(23)

GappyData <- list()

for(d in 1:length(OriginalData)){
  GappyData[[d]] <- simulateGaps(data = as.numeric(OriginalData[[d]]), prop_vec = prop_vec, gap_vec = gap_vec, K = K)
}
names(GappyData) <- names(OriginalData)

# dimension (d, p, g, k) 
```

# Check to see how many observations were removed; and if somewhat linear
```{r}
# Create plots
p=20
actual.gaps <- numeric()
expected.gaps <- numeric()

for(g in 1:length(GappyData[[1]][[1]])){
    actual.gaps[g] <- sum(is.na(GappyData[[1]][[p]][[g]][[1]]))
    expected.gaps[g] <- g
  }
names(actual.gaps) <- paste0("p",round(prop_vec[p],2),", g",gap_vec)
plot <- ggplot() + geom_line(aes(x = 1:length(gap_vec), y = actual.gaps)) + labs(x = "expected gaps", y = "actual gaps", title= paste0("mean = ",round(mean(actual.gaps),2),", expected = ", round(prop_vec[p]*1000),2)) + theme_minimal()

setwd("/home/sophie/sophTools/files/highRes/actualGaps")
png(paste0("p",p,".png"))
plot
dev.off()

# Get dataframe of results (actual and expected gaps)
mean.actual <- numeric()

for(p in 1:length(prop_vec)){
  actual.gaps <- numeric()
  for(g in 1:length(gap_vec)){
    actual.gaps[g] <- sum(is.na(GappyData[[1]][[p]][[g]][[2]]))
  }
  mean.actual[p] <- round(mean(actual.gaps),2)
}

result <- data.frame(expected = round(prop_vec*1000), actual = mean.actual, diff = mean.actual-round(prop_vec*1000))
setwd("/home/sophie/sophTools/files/highRes/actualGaps")
save(result, file = "result.rda")

setwd("/home/sophie/sophTools/files/highRes/actualGaps")
png("result.png")
plot(result$actual, type = "l", main = "Mean Actual Gaps", ylab = "Actual", xlab= "Expected")
dev.off()


setwd("/home/sophie/sophTools/files/highRes/actualGaps")
print(xtable(result), file="result.txt", include.rownames = F, sanitize.text.function = function(x) x)

```

# Split Data
```{r}
GappyData.hr <- load_obj("/home/sophie/sophTools/files/highRes/GappyData.hr.rda")
split = 20
splitData.hr <- splitData(GappyData.hr, split = split)
```

#INTERPOLATION
```{r IntData, cache = TRUE}
set.seed(23)
methods <- c(18)

# D1
for(n in 1:split){
    splitIntData <- parInterpolate(gappyTS = splitData.hr[[1]][[n]], methods = 18, numCores = 20)
    filename <- paste0("1_IntData.hr","_",letters[n],".rda")
    setwd(paste0("/home/sophie/sophTools/files/highRes/IntData.hr/D1"))
    save(splitIntData, file = filename)
    print(n)
    gc()
}

# D2
for(n in 1:split){
    splitIntData <- parInterpolate(gappyTS = splitData.hr[[2]][[n]], methods = 18, numCores = 25)
    filename <- paste0("2_IntData.hr","_",letters[n],".rda")
    setwd(paste0("/home/sophie/sophTools/files/highRes/IntData.hr/D2"))
    save(splitIntData, file = filename)
    print(n)
    gc()
}
# Note did not do split = 20 (time constraint)

# D3
for(n in 1:split){
    splitIntData <- parInterpolate(gappyTS = splitData.hr[[3]][[n]], methods = 18, numCores = 20)
    filename <- paste0("3_IntData.hr","_",letters[n],".rda")
    setwd(paste0("/home/sophie/sophTools/files/highRes/IntData.hr/D3"))
    save(splitIntData, file = filename)
    print(n)
    gc()
}

# D4
for(n in 1:split){
    splitIntData <- parInterpolate(gappyTS = splitData.hr[[4]][[n]], methods = 18, numCores = 20)
    filename <- paste0("4_IntData.hr","_",letters[n],".rda")
    setwd(paste0("/home/sophie/sophTools/files/highRes/IntData.hr/D4"))
    save(splitIntData, file = filename)
    print(n)
    gc()
}

# D5
for(n in 1:split){
    splitIntData <- parInterpolate(gappyTS = splitData.hr[[5]][[n]], methods = 18, numCores = 20)
    filename <- paste0("5_IntData.hr","_",letters[n],".rda")
    setwd(paste0("/home/sophie/sophTools/files/highRes/IntData.hr/D5"))
    save(splitIntData, file = filename)
    print(n)
    gc()
}
```

# STITCH DATA
```{r}
for(n in 20:20){
    splitIntData <- parInterpolate(gappyTS = splitData.hr[[2]][[n]], methods = 18, numCores = 25)
    filename <- paste0("2_IntData.hr","_",letters[n],".rda")
    setwd(paste0("/home/sophie/sophTools/files/highRes/IntData.hr/D2"))
    save(splitIntData, file = filename)
    print(n)
    gc()
}

IntData.hr.1 <- stitchData("/home/sophie/sophTools/files/highRes/IntData.hr/D1")
IntData.hr.2 <- stitchData("/home/sophie/sophTools/files/highRes/IntData.hr/D2")
IntData.hr.3 <- stitchData("/home/sophie/sophTools/files/highRes/IntData.hr/D3")
IntData.hr.4 <- stitchData("/home/sophie/sophTools/files/highRes/IntData.hr/D4")
IntData.hr.5 <- stitchData("/home/sophie/sophTools/files/highRes/IntData.hr/D5")

IntData.hr <- list(D1 = IntData.hr.1, D2 = IntData.hr.2, D3 = IntData.hr.3, D4 = IntData.hr.4, D5 = IntData.hr.5)
```

# PERFORMANCE MATRIX
```{r}
OriginalData.hr <- load_obj("/home/sophie/sophTools/files/new_1/testOriginalData.rda")
IntData.hr <- load_obj("/home/sophie/sophTools/files/highRes/IntData.hr.rda")
GappyData.hr <- load_obj("/home/sophie/sophTools/files/highRes/GappyData.hr.rda")

pMats.hr <- performance(OriginalData=OriginalData.hr, IntData=IntData.hr, GappyData = GappyData.hr)
ag.hr <- agEvaluate(pmats = pMats.hr)
setwd("/home/sophie/sophTools/files/highRes")
save(pMats.hr, file = "pMats.hr.rda")
save(ag.hr, file = "ag.hr.rda")
```

# Heatmaps (one metric)
```{r}
agEval <- load_obj("/home/sophie/sophTools/files/highRes/ag.hr.rda")
crit = "abs_differences"
m = "HWI"

setwd("/home/sophie/sophTools/files/highRes")
png(paste0(crit,"_Heatmap_hr.png"), width = 1136, height = 328)
heatmapGrid2(crit = crit, m = m, agEval = agEval)
dev.off()
```

# Heatmaps (multiple metrics)
```{r}
agEval <- load_obj("/home/sophie/sophTools/files/highRes/ag.hr.rda")

setwd("/home/sophie/sophTools/files/highRes")
png("multiHeatmaps_hr.png", width = 1100, height = 1100)
multiHeatmap(crit = c("NRMSD","MAPE","MRE","RMSS"), m = "HWI", agEval = new.ag)
dev.off()
```

# SURFACE PLOTS
```{r}
ag.hr <- load_obj("/home/sophie/sophTools/files/highRes/ag.hr.rda")

# Create legend
greyList <- c("#EAECEE", "#D5D8DC","#ABB2B9","#808B96", "#566573", "#2C3E50")
highlight = "HWI"
highlight_colour =  "#EE5C42"

# get z_list
z_list <- compileMatrix(agEval=ag.hr)[["median"]]

method_list_names <- names(z_list[[1]])
M <- length(method_list_names)

greyListMatch <- greyList[1:M]
names(greyListMatch) <- method_list_names
greyListMatch[[highlight]] <- highlight_colour
  
manualLegend <- data.frame(color = as.character(greyListMatch), 
                           nameSurface = method_list_names, 
                           x = rep(0,M), 
                           y = seq(0.20,0.80,length.out = M), 
                           textcol = as.character(greyListMatch),
                           stringsAsFactors = FALSE)

theLegend.hr <- plot_ly(data = manualLegend, showlegend = F) %>%
  
  add_markers(x = manualLegend$x,
              y = manualLegend$y, 
              size = 50, 
              name = manualLegend$nameSurface,
              color = I(manualLegend$color)) %>%
  
  add_text(x = manualLegend$x + 0.03,
           y = manualLegend$y,
           text = manualLegend$nameSurface,
           color = I(manualLegend$textcol),
           textposition = "right") %>% 
  
              layout(xaxis = list(title = "", 
                                  showgrid = F, 
                                  showticklabels = F,
                                  zeroline = F,
                                  range = c(-0.15,0.3)), 
                     yaxis = list(title = "", 
                                  showgrid = F, 
                                  showticklabels = F,
                                  zeroline = F,
                                  range = c(0,1.05)))
```

### Generate surface plots
```{r}
ps.hr <- plotSurface(agEval = ag.hr, m = "HWI", layer_type = "method", d = 1:5, highlight = "HWI", crit = "MAPE", f = "median", scale = "mint")

titleList <- list()

for(i in 1:length(ps.hr[[1]])){
      titleList[[i]] <- list(
        text = paste("Dataset ",i,sep=""),
        xref = "paper",
        yref = "paper",
        yanchor = "bottom",
        xanchor = "center",
        align = "center",
        x = 0.5,
        y = 0.75,
        showarrow = FALSE
      )
    }

pp1NRMSD.hr <- ps.hr[[1]][[1]] %>% layout(annotations = titleList[[1]])# criterion, dataset
pp2NRMSD.hr <- ps.hr[[1]][[2]] %>% layout(annotations = titleList[[2]])# criterion, dataset
pp3NRMSD.hr <- ps.hr[[1]][[3]] %>% layout(annotations = titleList[[3]])# criterion, dataset
pp4NRMSD.hr <- ps.hr[[1]][[4]] %>% layout(annotations = titleList[[4]])# criterion, dataset
pp5NRMSD.hr <- ps.hr[[1]][[5]] %>% layout(annotations = titleList[[5]])# criterion, dataset

sub1  <- subplot(pp1NRMSD.hr,pp2NRMSD.hr,pp3NRMSD.hr,pp4NRMSD.hr,pp5NRMSD.hr,theLegend.hr, nrows = 3) %>%
  
            layout(title = names(ps.hr)[1],
             
             scene = list(domain=list(x=c(0,1/2),  y=c(2/3,1)), 
                          aspectmode = 'manual', 
                          aspectratio=list(x=1,y=1,z=0.5),
                          camera = list(eye=list(x=1.65,y=-1.15,z=0.30))),
             
             scene2 = list(domain=list(x=c(1/2,1), y=c(2/3,1)), 
                           aspectmode = 'manual', 
                           aspectratio=list(x=1,y=1,z=0.5),
                           camera = list(eye=list(x=1.65,y=-1.15,z=0.30))),
             
             scene3 = list(domain=list(x=c(0,1/2), y=c(1/3,2/3)), 
                           aspectmode = 'manual', 
                           aspectratio=list(x=1,y=1,z=0.5),
                           camera = list(eye=list(x=1.65,y=-1.15,z=0.30))),
             
             scene4 = list(domain=list(x=c(1/2,1), y=c(1/3,2/3)), 
                           aspectmode = 'manual', 
                           aspectratio=list(x=1,y=1,z=0.5),
                           camera = list(eye=list(x=1.65,y=-1.15,z=0.30))),
             
             scene5 = list(domain=list(x=c(0,1/2), y=c(0,1/3)), 
                           aspectmode = 'manual', 
                           aspectratio=list(x=1,y=1,z=0.5),
                           camera = list(eye=list(x=1.65,y=-1.15,z=0.30))),
             
             scene6 = list(domain=list(x=c(1/2,1), y=c(0,1/3)))
             )
```

These are ugly ^ :) 


```{r}
OriginalData <- load_obj("/home/sophie/sophTools/files/new_2/testOriginalData.rda")
GappyData <- load_obj("/home/sophie/sophTools/files/new_2/testGappyData.rda")
IntData <- load_obj("/home/sophie/sophTools/files/new_2/testIntData.rda")

testpMats <- performance(OriginalData = OriginalData, GappyData = GappyData, IntData = IntData)
testag <- agEvaluate(testpMats)
testag <- convertNames(testag)

setwd("/home/sophie/sophTools/files/new_2")
save(testpMats, file = "testpMats.rda")
save(testag, file = "testag.rda")
```

```{r}
testag <- load_obj("/home/sophie/sophTools/files/new_2/testag.rda")
newag <- load_obj("/home/sophie/sophTools/files/new_1/new.ag.rda")

heatmapGrid2(agEval = newag, f = "median", crit = "NRMSD", m = "HWI", d = 1:5)

setwd("/home/sophie/sophTools/files/highRes")
png(paste0(crit,"_Heatmap_lr.png"), width = 1136, height = 328)
heatmapGrid2(crit = "NRMSD", m = "HWI", agEval = testag)
dev.off()

```


