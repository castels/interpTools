---
title: "legacy"
author: "Sophie Castel"
date: "2/10/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## function to pull out best and worst indices  d p m g 
```{r}
findBest <- function(pmats, d, p, m, g, crit, howMany = 5){
  
  K <- length(pmats[[d]][[m]][[p]][[g]])  
  
  myCrits <- names(pmats[[d]][[m]][[p]][[g]][[1]])
  
  criteria <- c("pearson_r", "r_squared","abs_differences","MBE","ME","MAE","MRE","MARE","MAPE","SSE","MSE","RMS","NMSE","RE","RMSE","NRMSD","RMSS","MdAPE","TMAPE")
  maximize <- c(1,1,rep(0,11),1,rep(0,5)) # 1 = yes, 0 = no
  optimal <- maximize
  optimal[which(optimal == "1")] <- "max"
  optimal[which(optimal == "0")] <- "min"
  
  best <- data.frame(criterion = criteria, maximize = maximize, optimal = optimal)
  
  best <- best[best$criterion %in% myCrits,]
    
  if(best[best$criterion == crit, "optimal"] == "max"){
    theWorst <- order(unlist(lapply(pmats[[d]][[m]][[p]][[g]], FUN = function(x) x[crit])))[1:howMany]
    theBest <- order(unlist(lapply(pmats[[d]][[m]][[p]][[g]], FUN = function(x) x[crit])))[((K+1)-howMany):K]
    
    bestVals <- unlist(lapply(pmats[[d]][[m]][[p]][[g]], FUN = function(x) x[crit]))[theBest]
    worstVals <- unlist(lapply(pmats[[d]][[m]][[p]][[g]], FUN = function(x) x[crit]))[theWorst]
  }
  else if(best[best$criterion == crit, "optimal"] == "min"){
    theBest <- order(unlist(lapply(pmats[[d]][[m]][[p]][[g]], FUN = function(x) x[crit])))[1:howMany]
    theWorst <- order(unlist(lapply(pmats[[d]][[m]][[p]][[g]], FUN = function(x) x[crit])))[((K+1)-howMany):K]
    
    bestVals <- unlist(lapply(pmats[[d]][[m]][[p]][[g]], FUN = function(x) x[crit]))[theBest]
    worstVals <- unlist(lapply(pmats[[d]][[m]][[p]][[g]], FUN = function(x) x[crit]))[theWorst]
  }
  
  result <- data.frame(c(rep("best",howMany),rep("worst",howMany)), c(theBest,theWorst), c(bestVals,worstVals))
  colnames(result) <- c("optim","index",crit)
  
  return(result)  
}
```

## function to plot comparison (original - int)
```{r}
plotBestDiff <- function(pmats, OriginalData, IntData, crit, d,p,g,m, howMany, optim = "best", raw = FALSE){
  
  find <-  findBest(pmats=pmats, crit=crit, d=d, p=p, g=g, m=m, howMany=howMany)
  best <- find[find$optim == "best","index"]
  worst <- find[find$optim == "worst","index"]
  
  K <- length(pmats[[d]][[m]][[p]][[g]])  
  par(mfrow = c(howMany,1))
  
  plotList <- list()
  
  if(optim == "best"){
    if(raw){
      for(i in 1:howMany){
        plot <- ggplot() + 
                geom_line(aes(x = 1:K, y = OriginalData[[d]]), col = "black", size = 0.2) + 
                geom_line(aes(x = 1:K, y = IntData[[d]][[m]][[p]][[g]][[best[i]]]), col = "red", size = 0.2) +
                labs(x = "t", y = "value", title = paste0(crit,", BEST",i,", index = ", best[i]), subtitle = paste0("d=",d,", p = ",p,", g = ",g, ", m = ",m)) + 
          theme_minimal()
        
        plotList[[i]] <- ggplotGrob(plot)
      }
    }
    
    
    else if(!raw){
      for(i in 1:howMany){
        plot <- ggplot() + geom_line(aes(x = 1:K, y = (OriginalData[[d]] - IntData[[d]][[m]][[p]][[g]][[best[i]]])), size = 0.2) + 
                  labs(x = "t", y = "Original-Int", title = paste0(crit,", BEST",i,", index = ", best[i]), subtitle = paste0("d=",d,", p = ",p,", g = ",g, ", m = ",m))+ 
          theme_minimal()
    
        plotList[[i]] <- ggplotGrob(plot)
    
    }
    }
  }
  
  else if(optim == "worst"){
    
    if(raw){
      for(i in 1:howMany){
        plot <- ggplot() + 
          geom_line(aes(x = 1:K, y = OriginalData[[d]]), col = "black", size = 0.2) + 
          geom_line(aes(x = 1:K, y = IntData[[d]][[m]][[p]][[g]][[worst[i]]]), col = "red", size = 0.2) +
          labs(x = "t", y = "value", title = paste0(crit,", WORST",i,", index = ", worst[i]), subtitle = paste0("d=",d,", p = ",p,", g = ",g, ", m = ",m)) + 
          theme_minimal()
        
        plotList[[i]] <- ggplotGrob(plot)
      }
    }
    else if(!raw){
    for(i in 1:howMany){
      plot <- ggplot() + geom_line(aes(x = 1:K, y = (OriginalData[[d]] - IntData[[d]][[m]][[p]][[g]][[worst[i]]])), size = 0.2) + 
        labs(x = "t", y = "Original-Int", title = paste0(crit,", WORST",i,", index = ", worst[i]), subtitle = paste0("d=",d,", p = ",p,", g = ",g, ", m = ",m)) + 
        theme_minimal()
      
      plotList[[i]] <- ggplotGrob(plot)
    }
    }
  }
  
  return(do.call("grid.arrange", c(plotList, ncol=1)))
}
```

## function to compare manual MAPEs with performance() MAPEs
```{r}
manualCompare <- function(pmats, d,p,g,m, howMany, OriginalData, GappyData, IntData, crit, optim = "worst"){
  manualFunc <- function(x,X){
    if (length(which(x == 0)) == 0) {
    value <- 100*(1/length(x)*sum(abs((x - X) / x)))
    } else {
      value <- NA 
    }
    return(value)
  }
  
  find <-  findBest(pmats=pmats, crit=crit, d=d, p=p, g=g, m=m, howMany=howMany)
  best <- find[find$optim == "best","index"]
  worst <- find[find$optim == "worst","index"]

  if(optim == "best"){
    optim = best
  }
  else if(optim == "worst"){
    optim = worst
  }
  
  for(i in 1:howMany){
  eval = eval_performance(x = OriginalData[[d]], X = IntData[[d]][[m]][[p]][[g]][[optim[i]]], gappyx = GappyData[[d]][[p]][[g]][[optim[i]]])[[crit]]
  
  index <- which(is.na(GappyData[[d]][[p]][[g]][[optim[i]]]))
  x <- OriginalData[[d]][index]
  X <- IntData[[d]][[m]][[p]][[g]][[optim[i]]][index]
  
  manual = manualFunc(x = x, X = X)
  
  print(eval-manual)
  }
}
```

# TESTING DATA
## legacy (~/original)
```{r}
pmats.1 <- load_obj("/home/sophie/sophTools/files/original/pmats.rda")
ag.1 <- load_obj("/home/sophie/sophTools/files/original/ag.rda")
ag.1 <- convertNames(ag.1)
simData.1 <- load_obj("/home/sophie/sophTools/files/original/simData.rda")
class(simData.1) = "simList"
class(ag.1) = "agEvaluate"
```

## (~/new_1)
```{r}
pmats.2 <- load_obj("/home/sophie/sophTools/files/new_1/new.pmats.rda")
ag.2 <- load_obj("/home/sophie/sophTools/files/new_1/new.ag.rda")
simData.2 <- load_obj("/home/sophie/sophTools/files/new_1/new.simData.rda")
class(simData.2) = "simList"
class(ag.2) = "agEvaluate"
```

## regenerated from (~/new_1)
```{r}
OriginalData <- load_obj("/home/sophie/sophTools/files/new_1/new.OriginalData.rda")
GappyData <- load_obj("/home/sophie/sophTools/files/new_1/new.GappyData.rda")
IntData <- load_obj("/home/sophie/sophTools/files/new_1/new.IntData.rda")

pmats.3 <- performance(OriginalData = OriginalData, GappyData = GappyData, IntData = IntData)
ag.3 <- agEvaluate(pmats = pmats.3)
simData.3 <- simData.2
class(ag.3) = "agEvaluate"
```

## (~/new_2)
```{r}
pmats.4 <- load_obj("/home/sophie/sophTools/files/new_2/testpMats.rda")
ag.4 <- load_obj("/home/sophie/sophTools/files/new_2/testag.rda")
ag.4 <- convertNames(ag.4)
simData.4 <- load_obj("/home/sophie/sophTools/files/new_2/testsimData.rda")
class(simData.4) = "simList"
class(ag.4) = "agEvaluate"
```

## Check to see values of MAPES from each pmats
```{r}
find.1 <- findBest(pmats = pmats.1, d = 4, p = 6, g = 4, crit = "MAPE", m = 6, howMany = 3)
find.2 <- findBest(pmats = pmats.2, d = 4, p = 6, g = 4, crit = "MAPE", m = "HWI", howMany = 3)
find.3 <- findBest(pmats = pmats.3, d = 4, p = 6, g = 4, crit = "MAPE", m = "HWI", howMany = 3)
find.4 <- findBest(pmats = pmats.4, d = 4, p = 6, g = 4, crit = "MAPE", m = 6, howMany = 3)
```

## plot the differences between the interpolated and original series
```{r}
plotBestDiff(pmats = pmats.1, d = 4, p = 6, g = 4, m = 6, crit = "MAPE", raw = F, OriginalData = OriginalData, IntData = IntData, howMany = 3, optim = "worst")
plotBestDiff(pmats = pmats.2, d = 4, p = 6, g = 4, m = "HWI", crit = "MAPE", raw = F, OriginalData = OriginalData, IntData = IntData, howMany = 3, optim = "worst")
plotBestDiff(pmats = pmats.3, d = 4, p = 6, g = 4, m = "HWI", crit = "MAPE", raw = F, OriginalData = OriginalData, IntData = IntData, howMany = 3, optim = "worst")
plotBestDiff(pmats = pmats.4, d = 4, p = 6, g = 4, m = 6, crit = "MAPE", raw = F, OriginalData = OriginalData, IntData = IntData, howMany = 3, optim = "worst")
```

## plot the interpolated series overtop of the original series
```{r}
plotBestDiff(pmats = pmats.1, d = 4, p = 6, g = 4, m = 6, crit = "MAPE", raw = T, OriginalData = OriginalData, IntData = IntData, howMany = 3, optim = "worst")
plotBestDiff(pmats = pmats.2, d = 4, p = 6, g = 4, m = "HWI", crit = "MAPE", raw = T, OriginalData = OriginalData, IntData = IntData, howMany = 3, optim = "worst")
plotBestDiff(pmats = pmats.3, d = 4, p = 6, g = 4, m = "HWI", crit = "MAPE", raw = T, OriginalData = OriginalData, IntData = IntData, howMany = 3, optim = "worst")
plotBestDiff(pmats = pmats.4, d = 4, p = 6, g = 4, m = 6, crit = "MAPE", raw = T, OriginalData = OriginalData, IntData = IntData, howMany = 3, optim = "worst")
```

## Check to see that the MAPE calculation is happening correctly
```{r}
manualCompare(pmats = pmats.1, howMany = 3, d = 4, m = 6, p = 6, g = 4, OriginalData = OriginalData, GappyData = GappyData, IntData= IntData, crit = "MAPE", optim = "worst")
manualCompare(pmats = pmats.2, howMany = 3, d = 4, m = "HWI", p = 6, g = 4, OriginalData = OriginalData, GappyData = GappyData, IntData= IntData, crit = "MAPE", optim = "worst")
manualCompare(pmats = pmats.3, howMany = 3, d = 4, m = "HWI", p = 6, g = 4, OriginalData = OriginalData, GappyData = GappyData, IntData= IntData, crit = "MAPE", optim = "worst")
manualCompare(pmats = pmats.4, howMany = 3, d = 4, m = 6, p = 6, g = 4, OriginalData = OriginalData, GappyData = GappyData, IntData= IntData, crit = "MAPE", optim = "worst")
```

## Plot Xt
```{r}
plotXt(d = 4, simData = simData.1)
plotXt(d = 4, simData = simData.2)
plotXt(d = 4, simData = simData.3)
plotXt(d = 4, simData = simData.4)
plotXt(d = 1, simData = simData.5)
```

## Plot the surfaces
```{r}
ps.1 <- plotSurface(agEval = ag.1, d = 1:5, crit = "MAPE", highlight = 4, layer_type = "dataset", m = "HWI")
ps.2 <- plotSurface(agEval = ag.2, d = 1:5, crit = "MAPE", highlight = 4, layer_type = "dataset", m = "HWI")
ps.3 <- plotSurface(agEval = ag.3, d = 1:5, crit = "MAPE", highlight = 4, layer_type = "dataset", m = "HWI")
ps.4 <- plotSurface(agEval = ag.4, d = 1:5, crit = "MAPE", highlight = 4, layer_type = "dataset", m = "HWI")
```

## Plot the frequency-shifted D4 (with gaps preserved)
```{r}
ag.5 <- load_obj("/home/sophie/sophTools/files/investigate/shift2/agEval.shift.2.rda")
ps.5 <- plotSurface(agEval = ag.5, d = 1, crit = "MAPE",  highlight = 1, layer_type = "dataset", m = "HWI")
simData.5 <- load_obj("/home/sophit/sophTools/files/investigate/shift2/")

# Just D4 
ps.1b <- plotSurface(agEval = ag.1, d = 4, crit = "MAPE", highlight = 4, layer_type = "dataset", m = "HWI")
ps.2b <- plotSurface(agEval = ag.2, d = 4, crit = "MAPE", highlight = 4, layer_type = "dataset", m = "HWI")
ps.3b <- plotSurface(agEval = ag.3, d = 4, crit = "MAPE", highlight = 4, layer_type = "dataset", m = "HWI")
ps.4b <- plotSurface(agEval = ag.4, d = 4, crit = "MAPE", highlight = 4, layer_type = "dataset", m = "HWI")
```

## Extract the f values for D4
```{r}
zlist.1 <- compileMatrix(ag.1)[["median"]][["MAPE"]][["HWI"]][["D4"]]
zlist.2 <- compileMatrix(ag.2)[["median"]][["MAPE"]][["HWI"]][["D4"]]
zlist.3 <- compileMatrix(ag.3)[["median"]][["MAPE"]][["HWI"]][["D4"]]
zlist.4 <- compileMatrix(ag.4)[["median"]][["MAPE"]][["HWI"]][["D4"]]
zlist.5 <- compileMatrix(ag.5)[["median"]][["MAPE"]][["HWI"]][[1]]

```
